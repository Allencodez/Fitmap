<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <section>
      <div class="container">
        <div class="content">
          <img id="logo" src="../Assets/images/Rectangle 1.png" alt="Image" />
          <p class="logo-name">Fitmap</p>
          <p class="head-text">Forgotten Password</p>
        </div>

        <div>
          <p class="name-text">Account Email</p>
          <div>
            <input
              id="fp-email"
              class="login-p-text"
              type="email"
              placeholder="you@example.com"
              required
            />
          </div>

          <p class="name-text" data-i18n="password">Enter New Password</p>
          <div>
            <input
              class="login-p-text"
              type="password"
              data-i18n="password"
              placeholder="********"
              id="newPass"
              required
            />
          </div>
          <p class="re-name-text" data-i18n="password">Re-Enter Password</p>
          <div>
            <input
              class="login-p-text"
              type="password"
              data-i18n="password"
              placeholder="********"
              id="rePass"
              required
            />
          </div>
        </div>

        <div class="confirm-btn">
          <button id="confirmPassBtn" disabled data-i18n="save_changes">
            Confirm
          </button>
        </div>
      </div>
      <p
        id="forgotMsg"
        class="validation-msg"
        style="
          display: none;
          color: #666;
          font-family: poppins;
          font-size: 0.9rem;
          margin-top: 8px;
        "
        aria-live="polite"
      >
        Please enter matching passwords to enable Confirm.
      </p>
      <p
        id="forgotSuccess"
        style="
          display: none;
          color: green;
          font-family: poppins;
          font-size: 0.95rem;
          margin-top: 8px;
        "
        aria-live="polite"
      >
        Password updated successfully — redirecting to Sign In…
      </p>
    </section>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const fpEmail = document.getElementById("fp-email");
      const newPass = document.getElementById("newPass");
      const rePass = document.getElementById("rePass");
      const btn = document.getElementById("confirmPassBtn");
      const forgotMsg = document.getElementById("forgotMsg");

      function showMsg(text, color = "#666") {
        if (!forgotMsg) return;
        forgotMsg.style.display = "block";
        forgotMsg.style.color = color;
        forgotMsg.textContent = text;
      }

      function validate() {
        const emailVal = fpEmail ? fpEmail.value.trim() : "";
        const a = newPass.value.trim();
        const b = rePass.value.trim();

        if (!emailVal) {
          btn.disabled = true;
          showMsg("Please enter the account email.");
          return;
        }

        const emailOk = /^\S+@\S+\.\S+$/.test(emailVal);
        if (!emailOk) {
          btn.disabled = true;
          showMsg("Enter a valid email address.");
          return;
        }

        // Enforce minimum password length and matching
        if (!a || !b) {
          btn.disabled = true;
          showMsg("Please enter matching passwords to enable Confirm.");
          return;
        }

        if (a.length < 6) {
          btn.disabled = true;
          showMsg("Password must be at least 6 characters.", "red");
          return;
        }

        if (a !== b) {
          btn.disabled = true;
          showMsg("Passwords do not match.", "red");
          return;
        }

        // Check stored user email
        let stored = null;
        try {
          const raw = localStorage.getItem("fitmap_user");
          stored = raw ? JSON.parse(raw) : null;
        } catch (e) {
          stored = null;
        }

        if (
          !stored ||
          !stored.email ||
          stored.email.toLowerCase() !== emailVal.toLowerCase()
        ) {
          btn.disabled = true;
          showMsg("No account found for this email.", "red");
          return;
        }

        // valid
        btn.disabled = false;
        if (forgotMsg) forgotMsg.style.display = "none";
      }

      [fpEmail, newPass, rePass].forEach(
        (el) => el && el.addEventListener("input", validate)
      );

      btn.addEventListener("click", function () {
        if (btn.disabled) return;
        // Save new password to localStorage for the user record (single-user support)
        try {
          const userKey = "fitmap_user";
          const raw = localStorage.getItem(userKey);
          let user = raw ? JSON.parse(raw) : {};
          user.password = newPass.value.trim();
          localStorage.setItem(userKey, JSON.stringify(user));
        } catch (e) {
          // ignore storage errors
        }
        // show success then redirect shortly
        const success = document.getElementById("forgotSuccess");
        if (success) {
          success.style.display = "block";
          if (forgotMsg) forgotMsg.style.display = "none";
        }
        setTimeout(() => {
          window.location.href = "sign-in.html";
        }, 1500);
      });

      validate();
    });
  </script>
</html>
